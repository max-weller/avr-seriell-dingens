<!doctype html>
<html>
<head>
<title>MQTT WebUI</title>
<meta name="viewport" content="width=device-width">
<script>
var MQTT_HOST = "10.83.42.11";
var MQTT_USERNAME = "webui";
</script>
<style>
html, body { margin: 0; padding: 0; }
#topbar { height: 5px; width: 100%; }
body {font-family: sans-serif;}
h4 { border-top: 1px solid #888; margin: 0 0; padding: 10px 20px 4px; background: #eee; font-weight: normal; }
h4 small { float: right; }
ul { margin: 0; padding: 0; list-style: none; }
ul li label { display: block; padding: 3px 20px; border-top: 1px solid #888; }
ul li input[type=range] { display: block; width: 100%; }
ul li input[type=checkbox] { float: right; }
ul li input[type=number] { float: right; text-align: right; }
ul li input[type=text] { float: right; }
ul li span { float: right; font-weight: bold; font-family: monospace; }
ul li small { font-size: 7pt; color: #666; }
#login form { padding: 20px;  }
</style>
</head>
<body>
<div id="topbar" style="background-color: #ff0000"></div>
<div id="devices"></div>

<script type="text/x-tmpl" id="device-list-template">
{% iterate(o.devices, filterEmptyAndOffline, (deviceId, device) => { %}

<h4>{%= device.attrs['$name'] %} &nbsp; 
    <small>fw={%= device.attrs['$fw/name'] %} {%= device.attrs['$fw/version'] %},  id={%= deviceId %}</small>
</h4>

<ul>
{% iterate(device.properties, (propName, prop) => { %}
    <li class="property prop-type-{%= prop['$datatype'] %}"><label><strong>{%= prop['$name'] %}</strong>
    <small>{%=propName%}</small>
    {% if (prop['$datatype'] == 'boolean') { %}
    <input type="checkbox" id="value:{%= prop.id %}"
        onchange="propertySet('{%= deviceId %}/{%= propName %}', this.checked?'true':'false')">
    {% } else if (prop['$settable'] !== 'true') { %}
    <span id="value:{%= prop.id %}"></span>
    {% } else if (isRangeProperty(prop)) { %}
    <input type="range" min="{%= getRange(prop)[0] %}" max="{%= getRange(prop)[1] %}" step="0.01"
        id="value:{%= prop.id %}"
        onchange="propertySet('{%= deviceId %}/{%= propName %}', this.value)">
    {% } else if (prop['$datatype'] == 'float' || prop['$datatype'] == 'integer') { %}
    <input type="number" id="value:{%= prop.id %}"
        onchange="propertySet('{%= deviceId %}/{%= propName %}', this.value)">
    {% } else { %}
    <input type="text" id="value:{%= prop.id %}"
        onchange="propertySet('{%= deviceId %}/{%= propName %}', this.value)">
    {% } %}
    </label></li>
{% }); %}
</ul>

{% }); %}
</script>

<div id="login">
    <form action="javascript:" id="loginform">
    Enter Password: <input type="password" id="pwfield"> <input type="submit" value="  ok  ">
    </form>
</div>

<script src="mqttws31.js"></script>
<script src="tmpl.js"></script>
<script>
if (!localStorage.uuid) localStorage.uuid = "webui-"+uuidv4();

var mqttprefix = "ham";
var devices = {};

function setIndicator(color) {
    document.getElementById("topbar").style.backgroundColor=color;
}
function blink(color) {
    setIndicator(color);
    setTimeout(()=>{ setIndicator("#bbbbbb");}, 500);
}

//--> Renderer
setInterval(function() {
    if (!devices_modified) return;
    devices_modified = false;
    blink("#00ffff");

    var container = document.getElementById("devices");
    container.innerHTML = tmpl("device-list-template", {'devices': devices});
    iterate(devices, filterEmptyAndOffline, (deviceId, device) => {
        iterate(device.properties, (propName, prop) => {
            propertyChangeReceived(prop);
        });
    });

    localStorage.devices=JSON.stringify(devices);
}, 1000);

document.getElementById("pwfield").value = localStorage.mqtt_pw ? localStorage.mqtt_pw : "";
document.getElementById("loginform").addEventListener("submit", function() {
    try{client.disconnect();}catch(e) {}
    localStorage.mqtt_pw = document.getElementById("pwfield").value;
    document.getElementById("devices").innerHTML="";
    devices={};
    client.connect({onSuccess:onConnect, onFailure:err, userName:"webui", password:document.getElementById("pwfield").value});
}, false);
try {
devices = JSON.parse(localStorage.devices);
}catch(e){}
if (typeof devices != "object") devices={};

function propertyChangeReceived(prop) {
    var el = document.getElementById("value:"+prop.id);
    if (!el) return;
    if(el.type=='checkbox') el.checked = prop.v=='true';
    else if ('value' in el) el.value = prop.v;
    else if ('innerText' in el) el.innerText = prop.v + (prop['$unit'] ? ' '+prop['$unit'] : '');
}

//--> MQTT Connection Manager

client = new Paho.MQTT.Client(MQTT_HOST, 1884, localStorage.uuid);

// set callback handlers
client.onConnectionLost = onConnectionLost;
client.onMessageArrived = onMessageArrived;

// connect the client
client.connect({onSuccess:onConnect, onFailure:err, userName:"webui", password:document.getElementById("pwfield").value});

function err(err) {
    setIndicator("#ff0000");
    console.log("connection failed",err.errorCode,err.errorMessage);
    document.getElementById("devices").innerHTML="";
    devices={};
}
// called when the client connects
function onConnect() {
  blink("#00ff00");
  // Once a connection has been made, make a subscription and send a message.
  console.log("onConnect");
  client.subscribe(mqttprefix+"/#");
}

// called when the client loses its connection
function onConnectionLost(responseObject) {
  if (responseObject.errorCode !== 0) {
    console.log("onConnectionLost:"+responseObject.errorMessage);
  }
}

// called when a message arrives
function onMessageArrived(message) {
  //console.log("onMessageArrived",message.destinationName+"=",message.payloadString);
  handleMessage(message.destinationName.split(/\//), message.payloadString);
}


//--> Homie Application Logic
function Property(deviceId, propname) {
    this.id = deviceId + ':' + propname;
    this.v = "";
}
function getOrCreateProperty(device, propname) {
    if (! (propname in device['properties'])) {
        device['properties'][propname] = new Property(device['$deviceId'], propname);
        devices_modified=true;
    }
    return device['properties'][propname];
}

var devices_modified=false;
function handleMessage(topic, payload) {
    if (topic.length < 3) {
        console.log("ignoring short topic", topic, payload);
        return;
    }
    if (topic[0] == mqttprefix) {
        var deviceId = topic[1];
        if (! (deviceId in devices)) {
            devices[deviceId]={'$deviceId': deviceId, 'attrs':{}, 'properties':{}};
            devices_modified=true;
        }
        var device = devices[deviceId];

        if (topic[2][0] == "$") { //#device attribute
            var attrname = topic.slice(2).join("/");
            console.log("updating device attr", deviceId, attrname, payload);
            device['attrs'][attrname] = payload;
            devices_modified=true;
        } else if (topic.length==5 && topic[4][0] == "$") { //# property attribute
            var propname = topic[2] + "/" + topic[3];
            var attrname = topic[4];
            var prop = getOrCreateProperty(device, propname);
            prop[attrname] = payload;
        } else if (topic.length==4) { //#property value
            var propname = topic[2] + "/" + topic[3];
            var prop = getOrCreateProperty(device, propname);
            prop.v = payload;
            propertyChangeReceived(prop);
        } else {
            console.log("ignoring msg", topic, payload);
        }
    }
}

function propertySet(id, value) {
  message = new Paho.MQTT.Message(value);
  message.destinationName = mqttprefix+"/"+id+"/set";
  client.send(message);
}

function filterEmptyAndOffline(device) {
    return device.attrs['$online'] === 'true' && !isObjectEmpty(device.properties);
}
function getRange(prop) {
    if (!prop['$format']) return false;
    var range = prop['$format'].split(/:/);
    if (range.length == 2) {
        return range;
    }
    return false;
}
function isRangeProperty(prop) {
    return (prop['$datatype'] == 'float' || prop['$datatype'] == 'integer') && getRange(prop);
}

//==> Helper
function iterate(dictionary, filter, cb) {
    if (cb === undefined) { cb = filter; filter = (x) => true; }
    for (var key in dictionary) {
        if (dictionary.hasOwnProperty(key) && filter(dictionary[key])) {
            cb(key, dictionary[key]);
        }
    }
}
function isObjectEmpty(obj) {
    for(var key in obj) {
        if (obj.hasOwnProperty(key)) return false;
    }
    return true;
}
function uuidv4() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

</script>
</body>
</html>
